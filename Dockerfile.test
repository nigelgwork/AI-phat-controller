FROM node:20-slim
WORKDIR /app

# Install build tools for native modules (better-sqlite3)
RUN apt-get update && \
    apt-get install -y python3 make g++ && \
    rm -rf /var/lib/apt/lists/*

# Copy package files
COPY package.json pnpm-lock.yaml* ./

# Install pnpm and dependencies
RUN corepack enable && corepack prepare pnpm@latest --activate
RUN pnpm install --frozen-lockfile || pnpm install

# Rebuild native modules
RUN npm rebuild better-sqlite3

# Copy source code
COPY . .

ENV NODE_ENV=test

CMD ["pnpm", "test:run"]
